#!/bin/bash -e

hst_this=$(hostname -s)
if ! echo "$hst_this" | egrep -q "^(admin|develop)"; then
  # unless the .ao_no_proxy file exists
  if [[ ! -f ".ao_no_proxy" ]]; then
    # ssh into deploy host and run from there
    exec bin/proxy $(basename $0) "$@"
    exit 1
  fi
fi

case "$(basename $0)" in
  debug)
    export LOCAL_ONLY=true

    {
    cap $(for a in "$@"; do echo $a.echo; done)
    }
    ;;

  hosts)
    export LOCAL_ONLY=true

    {
    cap $(for a in "$@"; do echo $a.echo; done)
    } 2>&1 | grep eea914aaa8dde6fdae29242b1084a2b0415eefaf | awk '{print $NF}' | sort -u
    ;;

  dna)
    export LOCAL_ONLY=true

    {
      echo "eea914aaa8dde6fdae29242b1084a2b0415eefaf -- "
      cap $(for a in "$@"; do echo $a.yaml; done)
    } 2>&1 | grep eea914aaa8dde6fdae29242b1084a2b0415eefaf | sed 's#eea914aaa8dde6fdae29242b1084a2b0415eefaf ##'
    ;;

  *)
    set $(for a in "$@"; do echo $a.app; done)
    case "$(basename $0)" in
      deploy|release)
        bundle exec cap "$@" deploy
        ;;

      rollback)
        bundle exec cap "$@" deploy:rollback
        ;;

      stage)
        bundle exec cap "$@" deploy:update_code
        ;;

      activate)
        bundle exec cap "$@" deploy:symlink deploy:restart
        ;;

      compare)
        bundle exec cap "$@" deploy:compare
        ;;

      restart)
        bundle exec cap "$@" deploy:restart
        ;;

      restart)
        bundle exec cap "$@" deploy:restart
        ;;

      build)
        bundle exec cap "$@" deploy:build
        ;;

      dist)
        bundle exec cap "$@" deploy:dist
        ;;

      config)
        bundle exec cap "$@" deploy:config
        ;;

      invoke)
        bundle exec cap "$@" invoke
        ;;

      shell)
        bundle exec cap "$@" shell
        ;;

      *)
        bundle exec cap "$@"
        ;;
  esac
esac

