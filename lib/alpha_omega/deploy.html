<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>deploy.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>deploy.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="vg">$:</span><span class="o">.</span><span class="n">unshift</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">),</span><span class="s1">&#39;..&#39;</span><span class="p">,</span><span class="s1">&#39;..&#39;</span><span class="p">,</span><span class="s1">&#39;lib&#39;</span><span class="p">))</span>

<span class="nb">require</span> <span class="s1">&#39;benchmark&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;yaml&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;json&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;alpha_omega/deploy/scm&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;alpha_omega/deploy/strategy&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;alpha_omega/utils&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;capistrano_colors&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;capistrano/log_with_awesome&#39;</span>

<span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;AO_USER&quot;</span><span class="o">]</span> <span class="o">||</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;AO_USER&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;USER&quot;</span><span class="o">]</span>

<span class="no">Capistrano</span><span class="o">::</span><span class="no">Configuration</span><span class="o">.</span><span class="n">instance</span><span class="p">(</span><span class="ss">:must_exist</span><span class="p">)</span><span class="o">.</span><span class="n">load</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>

  <span class="k">def</span> <span class="nf">_cset</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="k">unless</span> <span class="n">exists?</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
      <span class="n">set</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-the_deploy_will_fail_with_an_error.'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-the_deploy_will_fail_with_an_error.">&#182;</a>
        </div>
        <h1></h1>

<p>These variables MUST be set in the client capfiles. If they are not set,</p>

<h1>the deploy will fail with an error.</h1>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">_cset</span><span class="p">(</span><span class="ss">:application</span><span class="p">)</span> <span class="p">{</span> <span class="nb">abort</span> <span class="s2">&quot;Please specify the name of your application, set :application, &#39;foo&#39;&quot;</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:repository</span><span class="p">)</span>  <span class="p">{</span> <span class="nb">abort</span> <span class="s2">&quot;Please specify the repository that houses your application&#39;s code, set :repository, &#39;foo&#39;&quot;</span> <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-are_not_sufficient.'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-are_not_sufficient.">&#182;</a>
        </div>
        <h1></h1>

<p>These variables may be set in the client capfile if their default values</p>

<h1>are not sufficient.</h1>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">_cset</span> <span class="ss">:scm</span><span class="p">,</span> <span class="ss">:git</span>
  <span class="n">_cset</span> <span class="ss">:deploy_via</span><span class="p">,</span> <span class="ss">:checkout</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:branch</span><span class="p">)</span> <span class="p">{</span> <span class="no">AlphaOmega</span><span class="o">.</span><span class="n">what_branch</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:revision</span><span class="p">)</span> <span class="p">{</span> <span class="n">source</span><span class="o">.</span><span class="n">head</span> <span class="p">}</span>

  <span class="n">_cset</span> <span class="ss">:default_shell</span><span class="p">,</span> <span class="s2">&quot;/bin/bash&quot;</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:deploy_to</span><span class="p">)</span> <span class="p">{</span> <span class="s2">&quot;/data/</span><span class="si">#{</span><span class="n">application</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>

  <span class="n">_cset</span> <span class="ss">:root_user</span><span class="p">,</span> <span class="s2">&quot;root&quot;</span>
  <span class="n">_cset</span> <span class="ss">:root_group</span><span class="p">,</span> <span class="s2">&quot;root&quot;</span>

  <span class="n">_cset</span> <span class="ss">:dir_perms</span><span class="p">,</span> <span class="s2">&quot;0775&quot;</span>

  <span class="n">_cset</span> <span class="ss">:bundler_options</span><span class="p">,</span> <span class="s2">&quot;--deployment --without development:test&quot;</span>
  <span class="n">_cset</span> <span class="ss">:ruby_loader</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>

  <span class="n">_cset</span><span class="p">(</span><span class="ss">:run_method</span><span class="p">)</span>        <span class="p">{</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:use_sudo</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span> <span class="p">?</span> <span class="ss">:sudo</span> <span class="p">:</span> <span class="ss">:run</span> <span class="p">}</span>

  <span class="n">_cset</span> <span class="ss">:last_pod</span><span class="p">,</span> <span class="kp">nil</span>
  <span class="n">_cset</span> <span class="ss">:local_only</span><span class="p">,</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;LOCAL_ONLY&#39;</span><span class="o">]</span> <span class="p">?</span> <span class="kp">true</span> <span class="p">:</span> <span class="kp">false</span>

  <span class="n">_cset</span> <span class="p">(</span><span class="ss">:figlet</span><span class="p">)</span> <span class="p">{</span> <span class="o">[</span><span class="sx">%x(which figlet)</span><span class="o">.</span><span class="n">strip</span><span class="o">].</span><span class="n">reject</span> <span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="o">!</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">executable?</span> <span class="n">f</span><span class="p">)}</span><span class="o">.</span><span class="n">first</span> <span class="o">||</span> <span class="n">echo</span> <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-services,_logs'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-services,_logs">&#182;</a>
        </div>
        <h1></h1>

<h1>services, logs</h1>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">_cset</span> <span class="ss">:service_dir</span><span class="p">,</span>         <span class="s2">&quot;service&quot;</span>
  <span class="n">_cset</span> <span class="ss">:log_dir</span><span class="p">,</span>             <span class="s2">&quot;log&quot;</span>
  <span class="n">_cset</span> <span class="ss">:cache_dir</span><span class="p">,</span>           <span class="s2">&quot;cache&quot;</span>

  <span class="n">_cset</span><span class="p">(</span><span class="ss">:service_path</span><span class="p">)</span>       <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">deploy_to</span><span class="p">,</span> <span class="n">service_dir</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:log_path</span><span class="p">)</span>           <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">deploy_to</span><span class="p">,</span> <span class="n">log_dir</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:cache_path</span><span class="p">)</span>         <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">deploy_to</span><span class="p">,</span> <span class="n">cache_dir</span><span class="p">)</span> <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-changes_if_you_do_decide_to_muck_with_these!'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-changes_if_you_do_decide_to_muck_with_these!">&#182;</a>
        </div>
        <h1></h1>

<p>These variables should NOT be changed unless you are very confident in
what you are doing. Make sure you understand all the implications of your</p>

<h1>changes if you do decide to muck with these!</h1>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">_cset</span><span class="p">(</span><span class="ss">:source</span><span class="p">)</span>            <span class="p">{</span> <span class="no">Capistrano</span><span class="o">::</span><span class="no">Deploy</span><span class="o">::</span><span class="no">SCM</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">scm</span><span class="p">,</span> <span class="nb">self</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:strategy</span><span class="p">)</span>          <span class="p">{</span> <span class="no">Capistrano</span><span class="o">::</span><span class="no">Deploy</span><span class="o">::</span><span class="no">Strategy</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">deploy_via</span><span class="p">,</span> <span class="nb">self</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:real_revision</span><span class="p">)</span>     <span class="p">{</span> <span class="n">source</span><span class="o">.</span><span class="n">local</span><span class="o">.</span><span class="n">query_revision</span><span class="p">(</span><span class="n">revision</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">cmd</span><span class="o">|</span> <span class="n">with_env</span><span class="p">(</span><span class="s2">&quot;LC_ALL&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="n">run_locally</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>

  <span class="n">_cset</span> <span class="ss">:releases</span><span class="p">,</span>          <span class="o">[</span> <span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta&quot;</span><span class="p">,</span> <span class="s2">&quot;omega&quot;</span> <span class="o">]</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:releases_dir</span><span class="p">)</span>      <span class="p">{</span> <span class="n">releases</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s2">&quot;releases&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:releases_path</span><span class="p">)</span>     <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">deploy_to</span><span class="p">,</span> <span class="n">releases_dir</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:current_workarea</span><span class="p">)</span>  <span class="p">{</span> <span class="n">capture</span><span class="p">(</span><span class="s2">&quot;readlink </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2"> || true&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">[-</span><span class="mi">1</span><span class="o">]</span> <span class="o">||</span> <span class="n">releases</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-releases,_paths,_names'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-releases,_paths,_names">&#182;</a>
        </div>
        <h1></h1>

<h1>releases, paths, names</h1>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">_cset</span> <span class="ss">:previous_path_name</span><span class="p">,</span>      <span class="s2">&quot;previous&quot;</span>
  <span class="n">_cset</span> <span class="ss">:current_path_name</span><span class="p">,</span>       <span class="s2">&quot;current&quot;</span>
  <span class="n">_cset</span> <span class="ss">:next_path_name</span><span class="p">,</span>          <span class="s2">&quot;next&quot;</span>
  <span class="n">_cset</span> <span class="p">(</span><span class="ss">:active_path_name</span><span class="p">)</span>     <span class="p">{</span> <span class="n">current_path_name</span> <span class="p">}</span>
  <span class="n">_cset</span> <span class="ss">:compare_path_name</span><span class="p">,</span>       <span class="s2">&quot;compare&quot;</span>
  <span class="n">_cset</span> <span class="ss">:migrate_path_name</span><span class="p">,</span>       <span class="s2">&quot;migrate&quot;</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:deploy_path_name</span><span class="p">)</span>      <span class="p">{</span> <span class="n">current_path_name</span> <span class="p">}</span>

  <span class="n">_cset</span><span class="p">(</span><span class="ss">:previous_path</span><span class="p">)</span>         <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">deploy_to</span><span class="p">,</span> <span class="n">previous_path_name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:current_path</span><span class="p">)</span>          <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">deploy_to</span><span class="p">,</span> <span class="n">current_path_name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:external_path</span><span class="p">)</span>         <span class="p">{</span> <span class="n">current_path</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:next_path</span><span class="p">)</span>             <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">deploy_to</span><span class="p">,</span> <span class="n">next_path_name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:compare_path</span><span class="p">)</span>          <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">deploy_to</span><span class="p">,</span> <span class="n">compare_path_name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:migrate_path</span><span class="p">)</span>          <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">deploy_to</span><span class="p">,</span> <span class="n">migrate_path_name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:deploy_path</span><span class="p">)</span>           <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">deploy_to</span><span class="p">,</span> <span class="n">deploy_path_name</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">_cset</span><span class="p">(</span><span class="ss">:rollback_release_name</span><span class="p">)</span> <span class="p">{</span> 
    <span class="k">if</span> <span class="n">releases</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="n">w</span> <span class="o">=</span> <span class="n">current_workarea</span>
      <span class="n">releases</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">releases</span><span class="o">[</span><span class="p">(</span><span class="n">releases</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">w</span><span class="p">))</span><span class="o">%</span><span class="n">releases</span><span class="o">.</span><span class="n">length</span><span class="o">]</span>
    <span class="k">else</span>
      <span class="s2">&quot;&quot;</span>
    <span class="k">end</span>
  <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:previous_release_name</span><span class="p">)</span> <span class="p">{</span> 
    <span class="k">if</span> <span class="n">releases</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="n">w</span> <span class="o">=</span> <span class="n">current_workarea</span>
      <span class="n">releases</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">releases</span><span class="o">[</span><span class="p">(</span><span class="n">releases</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">releases</span><span class="o">.</span><span class="n">length</span><span class="o">]</span>
    <span class="k">else</span>
      <span class="s2">&quot;&quot;</span>
    <span class="k">end</span>
  <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:current_release_name</span><span class="p">)</span>  <span class="p">{</span> 
    <span class="k">if</span> <span class="n">releases</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="n">w</span> <span class="o">=</span> <span class="n">current_workarea</span>
      <span class="n">stage</span> <span class="o">=</span> <span class="n">releases</span><span class="o">[</span><span class="p">((</span><span class="n">releases</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">w</span><span class="p">)?</span><span class="n">releases</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="ss">:-</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">releases</span><span class="o">.</span><span class="n">length</span><span class="o">]</span>
      <span class="nb">system</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">figlet</span><span class="si">}</span><span class="s2"> -w 200 on </span><span class="si">#{</span><span class="n">stage</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="n">stage</span>
    <span class="k">else</span>
      <span class="s2">&quot;&quot;</span>
    <span class="k">end</span>
  <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:next_release_name</span><span class="p">)</span>     <span class="p">{</span> 
    <span class="k">if</span> <span class="n">releases</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="n">w</span> <span class="o">=</span> <span class="n">current_workarea</span>
      <span class="n">releases</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">releases</span><span class="o">[</span><span class="p">(</span><span class="n">releases</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">releases</span><span class="o">.</span><span class="n">length</span><span class="o">]</span>
    <span class="k">else</span>
      <span class="s2">&quot;&quot;</span>
    <span class="k">end</span>
  <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:active_release_name</span><span class="p">)</span>   <span class="p">{</span> <span class="n">current_workarea</span> <span class="p">}</span>
  <span class="n">_cset</span> <span class="ss">:compare_release_name</span><span class="p">,</span>    <span class="n">compare_path_name</span>
  <span class="n">_cset</span> <span class="ss">:migrate_release_name</span><span class="p">,</span>    <span class="n">migrate_path_name</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:deploy_release_name</span><span class="p">)</span>   <span class="p">{</span> <span class="n">current_release_name</span> <span class="p">}</span>

  <span class="n">_cset</span><span class="p">(</span><span class="ss">:rollback_release</span><span class="p">)</span>      <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">releases_path</span><span class="p">,</span> <span class="n">rollback_release_name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:previous_release</span><span class="p">)</span>      <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">releases_path</span><span class="p">,</span> <span class="n">previous_release_name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:current_release</span><span class="p">)</span>       <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">releases_path</span><span class="p">,</span> <span class="n">current_release_name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:next_release</span><span class="p">)</span>          <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">releases_path</span><span class="p">,</span> <span class="n">next_release_name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:active_release</span><span class="p">)</span>        <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">releases_path</span><span class="p">,</span> <span class="n">active_release_name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:compare_release</span><span class="p">)</span>       <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">releases_path</span><span class="p">,</span> <span class="n">compare_release_name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:migrate_release</span><span class="p">)</span>       <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">releases_path</span><span class="p">,</span> <span class="n">migrate_release_name</span><span class="p">)</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:deploy_release</span><span class="p">)</span>        <span class="p">{</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">releases_path</span><span class="p">,</span> <span class="n">deploy_release_name</span><span class="p">)</span> <span class="p">}</span>

  <span class="n">_cset</span><span class="p">(</span><span class="ss">:rollback_revision</span><span class="p">)</span>     <span class="p">{</span> <span class="n">capture</span><span class="p">(</span><span class="s2">&quot;cat </span><span class="si">#{</span><span class="n">rollback_release</span><span class="si">}</span><span class="s2">/REVISION&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:previous_revision</span><span class="p">)</span>     <span class="p">{</span> <span class="n">capture</span><span class="p">(</span><span class="s2">&quot;cat </span><span class="si">#{</span><span class="n">previous_release</span><span class="si">}</span><span class="s2">/REVISION&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:current_revision</span><span class="p">)</span>      <span class="p">{</span> <span class="n">capture</span><span class="p">(</span><span class="s2">&quot;cat </span><span class="si">#{</span><span class="n">current_release</span><span class="si">}</span><span class="s2">/REVISION&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:next_revision</span><span class="p">)</span>         <span class="p">{</span> <span class="n">capture</span><span class="p">(</span><span class="s2">&quot;cat </span><span class="si">#{</span><span class="n">next_release</span><span class="si">}</span><span class="s2">/REVISION&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:active_revision</span><span class="p">)</span>       <span class="p">{</span> <span class="n">capture</span><span class="p">(</span><span class="s2">&quot;cat </span><span class="si">#{</span><span class="n">active_release</span><span class="si">}</span><span class="s2">/REVISION&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:compare_revision</span><span class="p">)</span>      <span class="p">{</span> <span class="n">capture</span><span class="p">(</span><span class="s2">&quot;cat </span><span class="si">#{</span><span class="n">compare_release</span><span class="si">}</span><span class="s2">/REVISION&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:migrate_revision</span><span class="p">)</span>      <span class="p">{</span> <span class="n">capture</span><span class="p">(</span><span class="s2">&quot;cat </span><span class="si">#{</span><span class="n">migrate_release</span><span class="si">}</span><span class="s2">/REVISION&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:deploy_revision</span><span class="p">)</span>       <span class="p">{</span> <span class="n">capture</span><span class="p">(</span><span class="s2">&quot;cat </span><span class="si">#{</span><span class="n">deploy_release</span><span class="si">}</span><span class="s2">/REVISION&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span> <span class="p">}</span>
 </pre></div>
      </td>
    </tr>
    <tr id='section-deploy:lock_defaults'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-deploy:lock_defaults">&#182;</a>
        </div>
        <h1></h1>

<h1>deploy:lock defaults</h1>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">_cset</span><span class="p">(</span><span class="ss">:want_unlock</span><span class="p">)</span>  <span class="p">{</span> <span class="kp">true</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:lock_timeout</span><span class="p">)</span> <span class="p">{</span> <span class="mi">86400</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:lock_name</span><span class="p">)</span>    <span class="p">{</span> <span class="n">application</span> <span class="p">}</span>
  <span class="n">_cset</span><span class="p">(</span><span class="ss">:lock_path</span><span class="p">)</span>    <span class="p">{</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">log_path</span><span class="si">}</span><span class="s2">/.</span><span class="si">#{</span><span class="n">lock_name</span><span class="si">}</span><span class="s2">_deploy_lock&quot;</span> <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-These_are_helper_methods_that_will_be_available_to_your_recipes.'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-These_are_helper_methods_that_will_be_available_to_your_recipes.">&#182;</a>
        </div>
        <h1></h1>

<h1>These are helper methods that will be available to your recipes.</h1>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>Auxiliary helper method for the deploy:check' task. Lets you set up your
own dependencies.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">depend</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="n">deps</span> <span class="o">=</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:dependencies</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">deps</span><span class="o">[</span><span class="n">location</span><span class="o">]</span> <span class="o">||=</span> <span class="p">{}</span>
    <span class="n">deps</span><span class="o">[</span><span class="n">location</span><span class="o">][</span><span class="n">type</span><span class="o">]</span> <span class="o">||=</span> <span class="o">[]</span>
    <span class="n">deps</span><span class="o">[</span><span class="n">location</span><span class="o">][</span><span class="n">type</span><span class="o">]</span> <span class="o">&lt;&lt;</span> <span class="n">args</span>
    <span class="n">set</span> <span class="ss">:dependencies</span><span class="p">,</span> <span class="n">deps</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>Temporarily sets an environment variable, yields to a block, and restores
the value when it is done.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">with_env</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">saved</span><span class="p">,</span> <span class="no">ENV</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span><span class="p">,</span> <span class="n">value</span>
    <span class="k">yield</span>
  <span class="k">ensure</span>
    <span class="no">ENV</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span> <span class="o">=</span> <span class="n">saved</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>logs the command then executes it locally.
returns the command output as a string</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">run_locally</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">trace</span> <span class="s2">&quot;executing locally: </span><span class="si">#{</span><span class="n">cmd</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">logger</span>
    <span class="n">output_on_stdout</span> <span class="o">=</span> <span class="kp">nil</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="no">Benchmark</span><span class="o">.</span><span class="n">realtime</span> <span class="k">do</span>
      <span class="n">output_on_stdout</span> <span class="o">=</span> <span class="sb">`</span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="sb">`</span>
    <span class="k">end</span>
    <span class="k">if</span> <span class="vg">$?</span><span class="o">.</span><span class="n">to_i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="c1"># $? is command exit code (posix style)</span>
      <span class="k">raise</span> <span class="no">Capistrano</span><span class="o">::</span><span class="no">LocalArgumentError</span><span class="p">,</span> <span class="s2">&quot;Command </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> returned status code </span><span class="si">#{</span><span class="vg">$?</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">trace</span> <span class="s2">&quot;command finished in </span><span class="si">#{</span><span class="p">(</span><span class="n">elapsed</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="si">}</span><span class="s2">ms&quot;</span> <span class="k">if</span> <span class="n">logger</span>
    <span class="n">output_on_stdout</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>If a command is given, this will try to execute the given command, as
described below. Otherwise, it will return a string for use in embedding in
another command, for executing that command as described below.</p>

<p>If :run<em>method is :sudo (or :use</em>sudo is true), this executes the given command
via +sudo+. Otherwise is uses +run+. If :as is given as a key, it will be
passed as the user to sudo as, if using sudo. If the :as key is not given,
it will default to whatever the value of the :admin_runner variable is,
which (by default) is unset.</p>

<p>THUS, if you want to try to run something via sudo, and what to use the
root user, you&rsquo;d just to try<em>sudo(&lsquo;something&rsquo;). If you wanted to try</em>sudo as
someone else, you&rsquo;d just do try<em>sudo(&lsquo;something&rsquo;, :as =&gt; &ldquo;bob&rdquo;). If you
always wanted sudo to run as a particular user, you could do
set(:admin</em>runner, &ldquo;bob&rdquo;).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">try_sudo</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span> <span class="p">?</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span> <span class="p">:</span> <span class="p">{}</span>
    <span class="n">command</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">shift</span>
    <span class="k">raise</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">&quot;too many arguments&quot;</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">any?</span>

    <span class="n">as</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:as</span><span class="p">,</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:admin_runner</span><span class="p">,</span> <span class="kp">nil</span><span class="p">))</span>
    <span class="n">via</span> <span class="o">=</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:run_method</span><span class="p">,</span> <span class="ss">:sudo</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">command</span>
      <span class="n">invoke_command</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="ss">:via</span> <span class="o">=&gt;</span> <span class="n">via</span><span class="p">,</span> <span class="ss">:as</span> <span class="o">=&gt;</span> <span class="n">as</span><span class="p">)</span>
    <span class="k">elsif</span> <span class="n">via</span> <span class="o">==</span> <span class="ss">:sudo</span>
      <span class="n">sudo</span><span class="p">(</span><span class="ss">:as</span> <span class="o">=&gt;</span> <span class="n">as</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="s2">&quot;&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>Same as sudo, but tries sudo with :as set to the value of the :runner
variable (which defaults to &ldquo;app&rdquo;).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">def</span> <span class="nf">try_runner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="n">options</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span> <span class="p">?</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span> <span class="p">:</span> <span class="p">{}</span>
    <span class="n">args</span> <span class="o">&lt;&lt;</span> <span class="n">options</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="ss">:as</span> <span class="o">=&gt;</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:runner</span><span class="p">,</span> <span class="s2">&quot;app&quot;</span><span class="p">))</span>
    <span class="n">try_sudo</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-You_can_have_cap_give_you_a_summary_of_them_with_cap_-T'.'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-You_can_have_cap_give_you_a_summary_of_them_with_cap_-T'.">&#182;</a>
        </div>
        <h1></h1>

<p>These are the tasks that are available to help with deploying web apps.</p>

<h1>You can have cap give you a summary of them with cap -T'.</h1>

      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">namespace</span> <span class="ss">:deploy</span> <span class="k">do</span>
    <span class="n">desc</span> <span class="o">&lt;&lt;-</span><span class="no">DESC</span>
<span class="sh">      Deploys your project. This calls both `update&#39; and `restart&#39;. Note that \</span>
<span class="sh">      this will generally only work for applications that have already been deployed \</span>
<span class="sh">      once.</span>
<span class="no">    DESC</span>
    <span class="n">task</span> <span class="ss">:default</span> <span class="k">do</span>
      <span class="n">update</span>
      <span class="n">restart</span>
    <span class="k">end</span>

    <span class="n">desc</span> <span class="o">&lt;&lt;-</span><span class="no">DESC</span>
<span class="sh">      Copies your project and updates the symlink. It does this in a \</span>
<span class="sh">      transaction, so that if either `update_code&#39; or `symlink&#39; fail, all \</span>
<span class="sh">      changes made to the remote servers will be rolled back, leaving your \</span>
<span class="sh">      system in the same state it was in before `update&#39; was invoked. Usually, \</span>
<span class="sh">      you will want to call `deploy&#39; instead of `update&#39;, but `update&#39; can be \</span>
<span class="sh">      handy if you want to deploy, but not immediately restart your application.</span>
<span class="no">    DESC</span>
    <span class="n">task</span> <span class="ss">:update</span> <span class="k">do</span>
      <span class="n">transaction</span> <span class="k">do</span>
        <span class="n">update_code</span>
        <span class="n">symlink</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">task</span> <span class="ss">:bootstrap_code</span> <span class="k">do</span>
      <span class="k">if</span> <span class="n">releases</span><span class="o">.</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="c1"># without services and run as root</span>
        <span class="n">run</span> <span class="s2">&quot;[[ -d </span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="s2"> ]] || </span><span class="si">#{</span><span class="n">try_sudo</span><span class="si">}</span><span class="s2"> install -d -m </span><span class="si">#{</span><span class="n">dir_perms</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">try_sudo</span><span class="o">.</span><span class="n">empty?</span> <span class="p">?</span> <span class="s1">&#39;&#39;</span> <span class="p">:</span> <span class="s2">&quot;-o </span><span class="si">#{</span><span class="n">root_user</span><span class="si">}</span><span class="s2"> -g </span><span class="si">#{</span><span class="n">root_group</span><span class="si">}</span><span class="s2">&quot;</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">run</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">try_sudo</span><span class="si">}</span><span class="s2"> install -d -m </span><span class="si">#{</span><span class="n">dir_perms</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">try_sudo</span><span class="o">.</span><span class="n">empty?</span> <span class="p">?</span> <span class="s1">&#39;&#39;</span> <span class="p">:</span> <span class="s2">&quot;-o </span><span class="si">#{</span><span class="n">user</span><span class="si">}</span><span class="s2"> -g </span><span class="si">#{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">releases_path</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="s2">/log&quot;</span>
      <span class="k">else</span>
        <span class="n">dirs</span> <span class="o">=</span> <span class="o">[</span> <span class="n">releases_path</span><span class="p">,</span> <span class="n">service_path</span><span class="p">,</span> <span class="n">log_path</span><span class="p">,</span> <span class="n">cache_path</span> <span class="o">]</span>
        <span class="n">dir_args</span> <span class="o">=</span> <span class="n">dirs</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">d</span><span class="o">|</span> <span class="n">d</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">}</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
        <span class="n">run</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">try_sudo</span><span class="si">}</span><span class="s2"> install -d -m </span><span class="si">#{</span><span class="n">dir_perms</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">try_sudo</span><span class="o">.</span><span class="n">empty?</span> <span class="p">?</span> <span class="s1">&#39;&#39;</span> <span class="p">:</span> <span class="s2">&quot;-o </span><span class="si">#{</span><span class="n">user</span><span class="si">}</span><span class="s2"> -g </span><span class="si">#{</span><span class="n">group</span><span class="si">}</span><span class="s2">&quot;</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">deploy_to</span><span class="si">}</span><span class="s2"> &amp;&amp; install -d -m </span><span class="si">#{</span><span class="n">dir_perms</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">dir_args</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">desc</span> <span class="o">&lt;&lt;-</span><span class="no">DESC</span>
<span class="sh">      Copies your project to the remote servers. This is the first stage \</span>
<span class="sh">      of any deployment; moving your updated code and assets to the deployment \</span>
<span class="sh">      servers. You will rarely call this task directly, however; instead, you \</span>
<span class="sh">      should call the `deploy&#39; task (to do a complete deploy) or the `update&#39; \</span>
<span class="sh">      task (if you want to perform the `restart&#39; task separately).</span>
<span class="no">    DESC</span>
    <span class="n">task</span> <span class="ss">:update_code</span> <span class="k">do</span>
      <span class="n">bootstrap_code</span>
      <span class="n">strategy</span><span class="o">.</span><span class="n">deploy!</span>
      <span class="n">bundle</span>
      <span class="n">cook</span>
    <span class="k">end</span>

    <span class="n">task</span> <span class="ss">:symlink_next</span> <span class="k">do</span>
      <span class="k">if</span> <span class="n">releases</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">2</span>
        <span class="n">run</span> <span class="s2">&quot;ln -nfs </span><span class="si">#{</span><span class="n">current_release</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">next_path</span><span class="si">}</span><span class="s2">.new&quot;</span>
        <span class="n">run</span> <span class="s2">&quot;mv -T </span><span class="si">#{</span><span class="n">next_path</span><span class="si">}</span><span class="s2">.new </span><span class="si">#{</span><span class="n">next_path</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">desc</span> <span class="o">&lt;&lt;-</span><span class="no">DESC</span>
<span class="sh">      Updates the symlink to the most recently deployed version. Capistrano works \</span>
<span class="sh">      by putting each new release of your application in its own directory. When \</span>
<span class="sh">      you deploy a new version, this task&#39;s job is to update the `current&#39; symlink \</span>
<span class="sh">      to point at the new version. You will rarely need to call this task \</span>
<span class="sh">      directly; instead, use the `deploy&#39; task (which performs a complete \</span>
<span class="sh">      deploy, including `restart&#39;) or the &#39;update&#39; task (which does everything \</span>
<span class="sh">      except `restart&#39;).</span>
<span class="no">    DESC</span>
    <span class="n">task</span> <span class="ss">:symlink</span> <span class="k">do</span>
      <span class="k">if</span> <span class="n">releases</span><span class="o">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">on_rollback</span> <span class="k">do</span>
          <span class="k">if</span> <span class="n">rollback_release</span>
            <span class="n">run</span> <span class="s2">&quot;rm -f </span><span class="si">#{</span><span class="n">previous_path</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">next_path</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">run</span> <span class="s2">&quot;ln -nfs </span><span class="si">#{</span><span class="n">rollback_release</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">.new&quot;</span>
            <span class="n">run</span> <span class="s2">&quot;mv -T </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">.new </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">&quot;</span>
          <span class="k">else</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">important</span> <span class="s2">&quot;no previous release to rollback to, rollback of symlink skipped&quot;</span>
          <span class="k">end</span>
        <span class="k">end</span>

        <span class="k">if</span> <span class="n">releases</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">1</span>
          <span class="n">run</span> <span class="s2">&quot;ln -nfs </span><span class="si">#{</span><span class="n">current_release</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">.new&quot;</span>
          <span class="n">run</span> <span class="s2">&quot;mv -T </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">.new </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span>
          <span class="n">run</span> <span class="s2">&quot;rm -f </span><span class="si">#{</span><span class="n">previous_path</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">next_path</span><span class="si">}</span><span class="s2">&quot;</span>
          <span class="n">run</span> <span class="s2">&quot;ln -nfs </span><span class="si">#{</span><span class="n">current_release</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">.new&quot;</span>
          <span class="n">run</span> <span class="s2">&quot;mv -T </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">.new </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">&quot;</span>
          <span class="k">if</span> <span class="n">current_path</span> <span class="o">!=</span> <span class="n">external_path</span>
            <span class="n">run</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">external_path</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">deploy_to</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s2">&quot;&quot;</span> <span class="p">:</span> <span class="n">try_sudo</span><span class="si">}</span><span class="s2"> ln -nfs </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">external_path</span><span class="si">}</span><span class="s2">.new&quot;</span>
            <span class="n">run</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">external_path</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">deploy_to</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s2">&quot;&quot;</span> <span class="p">:</span> <span class="n">try_sudo</span><span class="si">}</span><span class="s2"> mv -T </span><span class="si">#{</span><span class="n">external_path</span><span class="si">}</span><span class="s2">.new </span><span class="si">#{</span><span class="n">external_path</span><span class="si">}</span><span class="s2">&quot;</span>
          <span class="k">end</span>
          <span class="n">run</span> <span class="s2">&quot;ln -nfs </span><span class="si">#{</span><span class="n">rollback_release</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">previous_path</span><span class="si">}</span><span class="s2">.new&quot;</span>
          <span class="n">run</span> <span class="s2">&quot;mv -T </span><span class="si">#{</span><span class="n">previous_path</span><span class="si">}</span><span class="s2">.new </span><span class="si">#{</span><span class="n">previous_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">end</span>

        <span class="nb">system</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">figlet</span><span class="si">}</span><span class="s2"> -w 200 </span><span class="si">#{</span><span class="n">current_release_name</span><span class="si">}</span><span class="s2"> activated&quot;</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">desc</span> <span class="o">&lt;&lt;-</span><span class="no">DESC</span>
<span class="sh">      Copy files to the currently deployed version. This is useful for updating \</span>
<span class="sh">      files piecemeal, such as when you need to quickly deploy only a single \</span>
<span class="sh">      file. Some files, such as updated templates, images, or stylesheets, \</span>
<span class="sh">      might not require a full deploy, and especially in emergency situations \</span>
<span class="sh">      it can be handy to just push the updates to production, quickly.</span>

<span class="sh">      To use this task, specify the files and directories you want to copy as a \</span>
<span class="sh">      comma-delimited list in the FILES environment variable. All directories \</span>
<span class="sh">      will be processed recursively, with all files being pushed to the \</span>
<span class="sh">      deployment servers.</span>

<span class="sh">        $ cap deploy:upload FILES=templates,controller.rb</span>

<span class="sh">      Dir globs are also supported:</span>

<span class="sh">        $ cap deploy:upload FILES=&#39;config/apache/*.conf&#39;</span>
<span class="no">    DESC</span>
    <span class="n">task</span> <span class="ss">:upload</span> <span class="k">do</span>
      <span class="n">files</span> <span class="o">=</span> <span class="p">(</span><span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;FILES&quot;</span><span class="o">]</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="no">Dir</span><span class="o">[</span><span class="n">f</span><span class="o">.</span><span class="n">strip</span><span class="o">]</span> <span class="p">}</span><span class="o">.</span><span class="n">flatten</span>
      <span class="nb">abort</span> <span class="s2">&quot;Please specify at least one file or directory to update (via the FILES environment variable)&quot;</span> <span class="k">if</span> <span class="n">files</span><span class="o">.</span><span class="n">empty?</span>

      <span class="n">files</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span> <span class="n">top</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">deploy_path</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span> <span class="p">}</span>
    <span class="k">end</span>

    <span class="n">desc</span> <span class="o">&lt;&lt;-</span><span class="no">DESC</span>
<span class="sh">      Restarts your application.</span>
<span class="no">    DESC</span>
    <span class="n">task</span> <span class="ss">:restart</span> <span class="k">do</span>
    <span class="k">end</span>

    <span class="n">desc</span> <span class="o">&lt;&lt;-</span><span class="no">DESC</span>
<span class="sh">      Builds binaries (like assets, jars, format conversions for distribution</span>
<span class="sh">      by deploy:dist.</span>
<span class="no">    DESC</span>
    <span class="n">task</span> <span class="ss">:build</span> <span class="k">do</span>
    <span class="k">end</span>

    <span class="n">desc</span> <span class="o">&lt;&lt;-</span><span class="no">DESC</span>
<span class="sh">      Distribute binaries built in deploy:build.</span>
<span class="no">    DESC</span>
    <span class="n">task</span> <span class="ss">:dist</span> <span class="k">do</span>
    <span class="k">end</span>

    <span class="n">desc</span> <span class="o">&lt;&lt;-</span><span class="no">DESC</span>
<span class="sh">      Checkpoint for various language bundlers</span>
<span class="no">    DESC</span>
    <span class="n">task</span> <span class="ss">:bundle</span> <span class="k">do</span>
    <span class="k">end</span>

    <span class="n">desc</span> <span class="o">&lt;&lt;-</span><span class="no">DESC</span>
<span class="sh">      Apply microwave tvdinners to a release directory.</span>
<span class="no">    DESC</span>
    <span class="n">task</span> <span class="ss">:cook</span> <span class="k">do</span>
    <span class="k">end</span>

    <span class="n">desc</span> <span class="o">&lt;&lt;-</span><span class="no">DESC</span>
<span class="sh">      Compares your application.</span>
<span class="no">    DESC</span>
    <span class="n">task</span> <span class="ss">:compare</span> <span class="k">do</span>
      <span class="n">set</span> <span class="ss">:deploy_path_name</span><span class="p">,</span> <span class="s2">&quot;compare&quot;</span>
      <span class="n">set</span> <span class="ss">:deploy_release_name</span><span class="p">,</span> <span class="s2">&quot;compare&quot;</span>
      <span class="n">update_code</span>
      <span class="n">run</span> <span class="s2">&quot;ln -nfs </span><span class="si">#{</span><span class="n">deploy_release</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">deploy_path</span><span class="si">}</span><span class="s2">.new&quot;</span>
      <span class="n">run</span> <span class="s2">&quot;mv -T </span><span class="si">#{</span><span class="n">deploy_path</span><span class="si">}</span><span class="s2">.new </span><span class="si">#{</span><span class="n">deploy_path</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>

    <span class="n">desc</span> <span class="o">&lt;&lt;-</span><span class="no">DESC</span>
<span class="sh">      Runs a repl in the compare release</span>
<span class="no">    DESC</span>
    <span class="n">task</span> <span class="ss">:repl</span> <span class="k">do</span>
      <span class="n">set</span> <span class="ss">:deploy_path_name</span><span class="p">,</span> <span class="s2">&quot;compare&quot;</span>
      <span class="n">set</span> <span class="ss">:deploy_release_name</span><span class="p">,</span> <span class="s2">&quot;compare&quot;</span>
      <span class="n">update_code</span>
      <span class="n">run</span> <span class="s2">&quot;ln -nfs </span><span class="si">#{</span><span class="n">deploy_release</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">deploy_path</span><span class="si">}</span><span class="s2">.new&quot;</span>
      <span class="n">run</span> <span class="s2">&quot;mv -T </span><span class="si">#{</span><span class="n">deploy_path</span><span class="si">}</span><span class="s2">.new </span><span class="si">#{</span><span class="n">deploy_path</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>

    <span class="n">namespace</span> <span class="ss">:rollback</span> <span class="k">do</span>
      <span class="n">desc</span> <span class="o">&lt;&lt;-</span><span class="no">DESC</span>
<span class="sh">        [internal] Points the current symlink at the previous revision.</span>
<span class="sh">        This is called by the rollback sequence, and should rarely (if</span>
<span class="sh">        ever) need to be called directly.</span>
<span class="no">      DESC</span>
      <span class="n">task</span> <span class="ss">:revision</span> <span class="k">do</span>
        <span class="k">if</span> <span class="n">previous_release</span>
          <span class="nb">system</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">figlet</span><span class="si">}</span><span class="s2"> -w 200 on </span><span class="si">#{</span><span class="n">previous_release_name</span><span class="si">}</span><span class="s2">&quot;</span>
          <span class="n">run</span> <span class="s2">&quot;rm -f </span><span class="si">#{</span><span class="n">previous_path</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">next_path</span><span class="si">}</span><span class="s2">&quot;</span>
          <span class="n">run</span> <span class="s2">&quot;ln -nfs </span><span class="si">#{</span><span class="n">previous_release</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">.new&quot;</span>
          <span class="n">run</span> <span class="s2">&quot;mv -T </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">.new </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span>
          <span class="nb">system</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">figlet</span><span class="si">}</span><span class="s2"> -w 200 failed to rollback&quot;</span>
          <span class="nb">abort</span> <span class="s2">&quot;could not rollback the code because there is no prior release&quot;</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="n">desc</span> <span class="o">&lt;&lt;-</span><span class="no">DESC</span>
<span class="sh">        [internal] Removes the most recently deployed release.</span>
<span class="sh">        This is called by the rollback sequence, and should rarely</span>
<span class="sh">        (if ever) need to be called directly.</span>
<span class="no">      DESC</span>
      <span class="n">task</span> <span class="ss">:cleanup</span> <span class="k">do</span>
      <span class="k">end</span>

      <span class="n">desc</span> <span class="o">&lt;&lt;-</span><span class="no">DESC</span>
<span class="sh">        Rolls back to the previously deployed version. The `current&#39; symlink will \</span>
<span class="sh">        be updated to point at the previously deployed version, and then the \</span>
<span class="sh">        current release will be removed from the servers. You&#39;ll generally want \</span>
<span class="sh">        to call `rollback&#39; instead, as it performs a `restart&#39; as well.</span>
<span class="no">      DESC</span>
      <span class="n">task</span> <span class="ss">:code</span> <span class="k">do</span>
        <span class="n">revision</span>
        <span class="n">cleanup</span>
      <span class="k">end</span>

      <span class="n">desc</span> <span class="o">&lt;&lt;-</span><span class="no">DESC</span>
<span class="sh">        Rolls back to a previous version and restarts. This is handy if you ever \</span>
<span class="sh">        discover that you&#39;ve deployed a lemon; `cap rollback&#39; and you&#39;re right \</span>
<span class="sh">        back where you were, on the previously deployed version.</span>
<span class="no">      DESC</span>
      <span class="n">task</span> <span class="ss">:default</span> <span class="k">do</span>
        <span class="n">revision</span>
        <span class="n">restart</span>
        <span class="n">cleanup</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">desc</span> <span class="o">&lt;&lt;-</span><span class="no">DESC</span>
<span class="sh">      Override in deploy recipes.  Formerly a railsy rake db:migrate.</span>
<span class="no">    DESC</span>
    <span class="n">task</span> <span class="ss">:migrate</span>  <span class="k">do</span>
      <span class="n">set</span> <span class="ss">:deploy_path_name</span><span class="p">,</span> <span class="s2">&quot;migrate&quot;</span>
      <span class="n">set</span> <span class="ss">:deploy_release_name</span><span class="p">,</span> <span class="s2">&quot;migrate&quot;</span>
      <span class="n">update_code</span>
      <span class="n">run</span> <span class="s2">&quot;ln -nfs </span><span class="si">#{</span><span class="n">deploy_release</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">deploy_path</span><span class="si">}</span><span class="s2">.new&quot;</span>
      <span class="n">run</span> <span class="s2">&quot;mv -T </span><span class="si">#{</span><span class="n">deploy_path</span><span class="si">}</span><span class="s2">.new </span><span class="si">#{</span><span class="n">deploy_path</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>

    <span class="n">desc</span> <span class="o">&lt;&lt;-</span><span class="no">DESC</span>
<span class="sh">      Test deployment dependencies. Checks things like directory permissions, \</span>
<span class="sh">      necessary utilities, and so forth, reporting on the things that appear to \</span>
<span class="sh">      be incorrect or missing. This is good for making sure a deploy has a \</span>
<span class="sh">      chance of working before you actually run `cap deploy&#39;.</span>

<span class="sh">      You can define your own dependencies, as well, using the `depend&#39; method:</span>

<span class="sh">        depend :remote, :gem, &quot;tzinfo&quot;, &quot;&gt;=0.3.3&quot;</span>
<span class="sh">        depend :local, :command, &quot;svn&quot;</span>
<span class="sh">        depend :remote, :directory, &quot;/u/depot/files&quot;</span>
<span class="no">    DESC</span>
    <span class="n">task</span> <span class="ss">:check</span> <span class="k">do</span>
      <span class="n">dependencies</span> <span class="o">=</span> <span class="n">strategy</span><span class="o">.</span><span class="n">check!</span>

      <span class="n">other</span> <span class="o">=</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:dependencies</span><span class="p">,</span> <span class="p">{})</span>
      <span class="n">other</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">location</span><span class="p">,</span> <span class="n">types</span><span class="o">|</span>
        <span class="n">types</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">type</span><span class="p">,</span> <span class="n">calls</span><span class="o">|</span>
          <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="ss">:gem</span>
            <span class="n">dependencies</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">location</span><span class="p">)</span><span class="o">.</span><span class="n">command</span><span class="p">(</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:gem_command</span><span class="p">,</span> <span class="s2">&quot;gem&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">or</span><span class="p">(</span><span class="s2">&quot;`gem&#39; command could not be found. Try setting :gem_command&quot;</span><span class="p">)</span>
          <span class="k">end</span>

          <span class="n">calls</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">args</span><span class="o">|</span>
            <span class="n">dependencies</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">location</span><span class="p">)</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
          <span class="k">end</span>
        <span class="k">end</span>
      <span class="k">end</span>

      <span class="k">if</span> <span class="n">dependencies</span><span class="o">.</span><span class="n">pass?</span>
        <span class="nb">puts</span> <span class="s2">&quot;You appear to have all necessary dependencies installed&quot;</span>
      <span class="k">else</span>
        <span class="nb">puts</span> <span class="s2">&quot;The following dependencies failed. Please check them and try again:&quot;</span>
        <span class="n">dependencies</span><span class="o">.</span><span class="n">reject</span> <span class="p">{</span> <span class="o">|</span><span class="n">d</span><span class="o">|</span> <span class="n">d</span><span class="o">.</span><span class="n">pass?</span> <span class="p">}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">d</span><span class="o">|</span>
          <span class="nb">puts</span> <span class="s2">&quot;--&gt; </span><span class="si">#{</span><span class="n">d</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">end</span>
        <span class="nb">abort</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">desc</span> <span class="o">&lt;&lt;-</span><span class="no">DESC</span>
<span class="sh">      Start the application servers.</span>
<span class="no">    DESC</span>
    <span class="n">task</span> <span class="ss">:start</span> <span class="k">do</span>
    <span class="k">end</span>

    <span class="n">desc</span> <span class="o">&lt;&lt;-</span><span class="no">DESC</span>
<span class="sh">      Stop the application servers.</span>
<span class="no">    DESC</span>
    <span class="n">task</span> <span class="ss">:stop</span> <span class="k">do</span>
    <span class="k">end</span>

    <span class="n">namespace</span> <span class="ss">:pending</span> <span class="k">do</span>
      <span class="n">desc</span> <span class="o">&lt;&lt;-</span><span class="no">DESC</span>
<span class="sh">        Displays the `diff&#39; since your last deploy. This is useful if you want \</span>
<span class="sh">        to examine what changes are about to be deployed. Note that this might \</span>
<span class="sh">        not be supported on all SCM&#39;s.</span>
<span class="no">      DESC</span>
      <span class="n">task</span> <span class="ss">:diff</span> <span class="k">do</span>
        <span class="nb">system</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">local</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">current_revision</span><span class="p">))</span>
      <span class="k">end</span>

      <span class="n">desc</span> <span class="o">&lt;&lt;-</span><span class="no">DESC</span>
<span class="sh">        Displays the commits since your last deploy. This is good for a summary \</span>
<span class="sh">        of the changes that have occurred since the last deploy. Note that this \</span>
<span class="sh">        might not be supported on all SCM&#39;s.</span>
<span class="no">      DESC</span>
      <span class="n">task</span> <span class="ss">:default</span> <span class="k">do</span>
        <span class="n">from</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">next_revision</span><span class="p">(</span><span class="n">current_revision</span><span class="p">)</span>
        <span class="nb">system</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">local</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">from</span><span class="p">))</span>
      <span class="k">end</span>
    <span class="k">end</span>

    <span class="n">task</span> <span class="ss">:lock</span> <span class="k">do</span>
      <span class="n">bootstrap_code</span>

      <span class="n">epoch</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_i</span>
      <span class="n">locker</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

      <span class="n">run</span> <span class="s2">&quot;cat </span><span class="si">#{</span><span class="n">lock_path</span><span class="si">}</span><span class="s2"> 2&gt;&amp;- || true&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">ch</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">data</span><span class="o">|</span>
        <span class="n">locker</span> <span class="o">&lt;&lt;</span> <span class="n">data</span>
      <span class="k">end</span>

      <span class="k">if</span> <span class="o">!</span><span class="n">locker</span><span class="o">.</span><span class="n">empty?</span>
        <span class="n">lock_epoch</span> <span class="o">=</span> <span class="n">locker</span><span class="o">.</span><span class="n">split</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">to_i</span>
        <span class="n">lock_user</span> <span class="o">=</span> <span class="n">locker</span><span class="o">.</span><span class="n">split</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>

        <span class="n">lock_elasped</span> <span class="o">=</span> <span class="n">epoch</span><span class="o">-</span><span class="n">lock_epoch</span>

        <span class="k">if</span> <span class="n">lock_elasped</span> <span class="o">&lt;</span> <span class="n">lock_timeout</span>
          <span class="kp">true</span> <span class="c1"># don&#39;t do anything if lock times out, just advise unlock</span>
        <span class="k">end</span>

        <span class="nb">system</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">figlet</span><span class="si">}</span><span class="s2"> failed to lock&quot;</span>
        <span class="nb">puts</span> <span class="s2">&quot;deploy locked by </span><span class="si">#{</span><span class="n">lock_user</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">epoch</span><span class="o">-</span><span class="n">lock_epoch</span><span class="si">}</span><span class="s2"> seconds ago&quot;</span>
        <span class="nb">puts</span> <span class="s2">&quot;use bin/unlock to remove this lock&quot;</span>
        <span class="nb">abort</span>
      <span class="k">end</span>

      <span class="n">run_script</span> <span class="o">=</span> <span class="o">&lt;&lt;-</span><span class="no">SCRIPT</span>
<span class="sh">        echo #{epoch} #{ENV[&#39;AO_USER&#39;]} &gt; #{lock_path};</span>
<span class="no">      SCRIPT</span>

      <span class="k">if</span> <span class="n">want_unlock</span>
        <span class="nb">at_exit</span> <span class="p">{</span> <span class="nb">self</span><span class="o">.</span><span class="n">unlock</span><span class="p">;</span> <span class="p">}</span>
      <span class="k">end</span>

      <span class="n">run</span> <span class="n">run_script</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/[\n\r]+[ \t]+/</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">task</span> <span class="ss">:lock_compare</span> <span class="k">do</span>
      <span class="n">set</span> <span class="ss">:lock_name</span><span class="p">,</span> <span class="ss">:compare</span>
      <span class="n">lock</span>
    <span class="k">end</span>

    <span class="n">task</span> <span class="ss">:lock_migrate</span> <span class="k">do</span>
      <span class="n">set</span> <span class="ss">:lock_name</span><span class="p">,</span> <span class="ss">:migrate</span>
      <span class="n">lock</span>
    <span class="k">end</span>

    <span class="n">task</span> <span class="ss">:dont_unlock</span>  <span class="k">do</span>
      <span class="n">set</span> <span class="ss">:want_unlock</span><span class="p">,</span> <span class="kp">false</span>
    <span class="k">end</span>

    <span class="n">task</span> <span class="ss">:unlock_compare</span> <span class="k">do</span>
      <span class="n">set</span> <span class="ss">:lock_name</span><span class="p">,</span> <span class="ss">:compare</span>
      <span class="n">unlock</span>
    <span class="k">end</span>

    <span class="n">task</span> <span class="ss">:unlock_migrate</span> <span class="k">do</span>
      <span class="n">set</span> <span class="ss">:lock_name</span><span class="p">,</span> <span class="ss">:migrate</span>
      <span class="n">unlock</span>
    <span class="k">end</span>

    <span class="n">task</span> <span class="ss">:unlock</span> <span class="k">do</span>
      <span class="k">if</span> <span class="n">want_unlock</span>
        <span class="n">run</span> <span class="s2">&quot;rm -f </span><span class="si">#{</span><span class="n">lock_path</span><span class="si">}</span><span class="s2">&quot;</span>
      <span class="k">end</span>
    <span class="k">end</span>

  <span class="k">end</span> <span class="c1"># :deploy</span>

  <span class="n">namespace</span> <span class="ss">:ruby</span> <span class="k">do</span>
    <span class="n">task</span> <span class="ss">:bundle</span> <span class="k">do</span>
      <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">deploy_release</span><span class="si">}</span><span class="s2"> &amp;&amp; bin/bundle-ruby </span><span class="si">#{</span><span class="n">ruby_loader</span><span class="si">}</span><span class="s2"> -- </span><span class="si">#{</span><span class="n">bundler_options</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">after</span> <span class="s2">&quot;deploy:bundle&quot;</span><span class="p">,</span> <span class="s2">&quot;ruby:bundle&quot;</span>

  <span class="n">namespace</span> <span class="ss">:node</span> <span class="k">do</span>
    <span class="n">task</span> <span class="ss">:bundle</span> <span class="k">do</span>
      <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">deploy_release</span><span class="si">}</span><span class="s2"> &amp;&amp; bin/bundle-node&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">after</span> <span class="s2">&quot;deploy:bundle&quot;</span><span class="p">,</span> <span class="s2">&quot;node:bundle&quot;</span>

  <span class="n">on</span> <span class="ss">:exit</span> <span class="k">do</span>
    <span class="k">unless</span> <span class="n">local_only</span>
      <span class="n">put</span> <span class="n">full_log</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">log_path</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">application</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="no">ENV</span><span class="o">[</span><span class="s2">&quot;AO_USER&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">.log-</span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m%d-%H%M&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span> <span class="c1"># Capistrano::Configuration</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
